---
title: "Test"
author: "viv3kanand"
date: "2023-11-01"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(tidyverse)
library(mclust) # For fitting GMM

### Evaluating clusters
#renv::install("ramey/clusteval")
#renv::install("factoextra")
```

```{r}
file1 <- "../data/out/barcode03.hg19.strique.tsv"
file2 <- "../data/out/barcode86.hg19.strique.tsv"

df1 <- read.table(file1, header = TRUE)
df2 <- read.table(file2, header = TRUE)

df <- rbind(df1,df2)

#file <- "../data/out/barcode02.hg19.strique.tsv"
#df <- read.table(file, header = TRUE)

df %>% filter(count > 3 & score_prefix >= 4 & score_suffix >= 4) -> df
set.seed(666)
fit <- Mclust(df$count)

prob <- predict(fit)

df$allele <- apply(prob$z, 1, which.max)
df$id <- str_remove(basename(file), ".hg19.strique.tsv")

mode_df <- df %>%
    group_by(id, allele) %>%
    summarise(allele_freq = n(),
              mode_repeat = as.numeric(names(sort(table(count), decreasing = TRUE)[1])),
              repeat_freq = max(table(count)),
              prop = repeat_freq/allele_freq)

mode_df %>% arrange(allele_freq)


```


```{r}
ggplot(df, aes(x = count, fill = factor(allele))) +
    geom_density(alpha = 0.5) +
    scale_fill_manual(values = c("red", "blue", "green")) +
    theme_minimal() +
    geom_vline(xintercept = c(mode_df$mode_repeat[2], mode_df$mode_repeat[3]), linetype = "dashed")
```



```{r}
#14, 38, 61, 63

FGF14 <- read.csv("../data/FGF14-sample data.csv")

file_paths <- list.files("../data/out/", full.names = TRUE)

result_df <- data.frame()

process_file <- function(file_path) {
  df <- read.table(file_path, header = TRUE)
  
  df_filtered <- df %>%
    filter(count > 3, score_prefix >= 4, score_suffix >= 4) %>% 
    mutate(id = str_remove(basename(file_path), ".hg19.strique.tsv"))
  
  set.seed(666)
  
  fit <- Mclust(df_filtered$count)
  prob <- predict(fit)
  
  df_filtered$allele <- apply(prob$z, 1, which.max)
  
  mode_df <- df_filtered %>%
    group_by(id, allele) %>%
    summarise(
      allele_freq = n(),
      mode_repeat = as.numeric(names(sort(table(count), decreasing = TRUE)[1])),
      repeat_freq = max(table(count)),
      prop = repeat_freq/allele_freq,
      .groups = 'drop'
    ) %>% 
    arrange(desc(allele_freq))

  return(mode_df)
}

# df_filtered <- lapply(setNames(file_paths, str_remove(basename(file_paths), ".hg19.strique.tsv")), function(file_path){
#   process_file(file_path)
# })

result_df <- lapply(file_paths, function(file_path){
  process_file(file_path)
}) %>% 
  Reduce(function(...) merge(..., all=T), .) %>% 
  pivot_wider(names_from = allele, values_from = c(mode_repeat, repeat_freq, allele_freq, prop))

result_df <- merge(FGF14, result_df, by.x = "barcode", by.y = "id")

#result_df %>% select(barcode, PCR.LA., PCR.UA., repeat_count_A1, repeat_count_A2) %>% View

write.csv(result_df, paste0("results/", Sys.Date(), "_FGF14_result.csv"))


```


### Interruptions
```{r}

```



























